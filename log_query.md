# æ€»æ¶ˆè€— æ—¥å¿—æŸ¥è¯¢

## æ€»æ¶ˆè€—æŸ¥è¯¢å†…å®¹åœ¨DMXAPIçš„ä½ç½®

![log_query](img/log_query_01.png)

## æ¥å£åœ°å€
```
https://www.dmxapi.cn/api/log/self/stat
```

## ä»£ç ç¤ºä¾‹
```python
"""
================================================================================
                           API æ€»æ¶ˆè€—ç»Ÿè®¡æŸ¥è¯¢å·¥å…·
================================================================================
åŠŸèƒ½æè¿°: æŸ¥è¯¢ dmxapi.cn å¹³å°çš„ API ä½¿ç”¨ç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬æ€»æ¶ˆè€—é¢åº¦ã€
         è¯·æ±‚é¢‘ç‡(RPM)ã€Tokenæ¶ˆè€—(TPM)ã€æ¶ˆæ¯æ•°é‡(MPM)ç­‰æŒ‡æ ‡ã€‚
ä½¿ç”¨æ–¹æ³•:
    1. é…ç½® SYSTEM_TOKEN å’Œ USER_ID
    2. è¿è¡Œè„šæœ¬: python æ€»æ¶ˆè€—æŸ¥è¯¢.py
    3. æŸ¥çœ‹ç»Ÿè®¡ç»“æœ

è¿”å›æ•°æ®è¯´æ˜:
    - quota : æ€»æ¶ˆè€—é¢åº¦
    - rpm   : Requests Per Minute  - æ¯åˆ†é’Ÿè¯·æ±‚æ•°
    - tpm   : Tokens Per Minute    - æ¯åˆ†é’Ÿ Token æ¶ˆè€—æ•°
    - mpm   : Messages Per Minute  - æ¯åˆ†é’Ÿæ¶ˆæ¯æ•°

================================================================================
"""
import requests
from datetime import datetime
# ==============================================================================
#                               é…ç½®ä¿¡æ¯åŒºåŸŸ
# ==============================================================================

# API æ¥å£åœ°å€ - ä¸ªäººç»Ÿè®¡æ•°æ®æŸ¥è¯¢ç«¯ç‚¹
URL = "https://www.dmxapi.cn/api/log/self/stat"

# ------------------------------------------------------------------------------
# è®¤è¯ä¿¡æ¯é…ç½® (è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ä¿¡æ¯)
# ------------------------------------------------------------------------------
# SYSTEM_TOKEN: ç³»ç»Ÿä»¤ç‰Œï¼Œç”¨äº API è®¤è¯
#               è·å–æ–¹å¼: ç™»å½• dmxapi.cn -> ä¸ªäººè®¾ç½® -> API ä»¤ç‰Œ
SYSTEM_TOKEN = "sk-********************"  # æ›¿æ¢ä¸ºä½ çš„ç³»ç»Ÿä»¤ç‰Œ

# USER_ID: ç”¨æˆ·å”¯ä¸€æ ‡è¯†
#          è·å–æ–¹å¼: ç™»å½• dmxapi.cn -> ä¸ªäººè®¾ç½® -> ç”¨æˆ· ID
USER_ID = "**********"  # æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ· ID

# ------------------------------------------------------------------------------
# æ—¶é—´èŒƒå›´é…ç½®
# ------------------------------------------------------------------------------
# QUERY_MODE: æŸ¥è¯¢æ¨¡å¼é€‰æ‹©
#   "today"      - æŸ¥è¯¢ä»Šå¤©çš„æ•°æ®
#   "yesterday"  - æŸ¥è¯¢æ˜¨å¤©çš„æ•°æ®
#   "week"       - æŸ¥è¯¢æœ€è¿‘7å¤©çš„æ•°æ®
#   "month"      - æŸ¥è¯¢æœ€è¿‘30å¤©çš„æ•°æ®
#   "custom"     - è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ï¼ˆéœ€è¦è®¾ç½®ä¸‹æ–¹çš„ CUSTOM_START å’Œ CUSTOM_ENDï¼‰
QUERY_MODE = "today"

# è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ï¼ˆä»…å½“ QUERY_MODE = "custom" æ—¶ç”Ÿæ•ˆï¼‰
# æ ¼å¼: "YYYY-MM-DD" æˆ– "YYYY-MM-DD HH:MM:SS"
CUSTOM_START = "2025-01-01 00:00:00"
CUSTOM_END = "2025-01-01 23:59:59"


# ==============================================================================
#                               æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
# ==============================================================================

def get_stat_data(start_timestamp: int, end_timestamp: int, stat_type: int = 0,
                  token_name: str = "", token_group: str = "", model_name: str = ""):
    """
    è·å– API æ€»æ¶ˆè€—ç»Ÿè®¡æ•°æ®

    é€šè¿‡è°ƒç”¨ /api/log/self/stat æ¥å£ï¼ŒæŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„ API ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ã€‚

    Args:
        start_timestamp (int): æŸ¥è¯¢å¼€å§‹æ—¶é—´çš„ Unix æ—¶é—´æˆ³ (ç§’)
                               ä¾‹å¦‚: 1702080000 è¡¨ç¤º 2023-12-09 00:00:00
        end_timestamp (int):   æŸ¥è¯¢ç»“æŸæ—¶é—´çš„ Unix æ—¶é—´æˆ³ (ç§’)
                               ä¾‹å¦‚: 1702166399 è¡¨ç¤º 2023-12-09 23:59:59
        stat_type (int):       ç»Ÿè®¡ç±»å‹ï¼Œé»˜è®¤ä¸º 0 (å…¨éƒ¨ç»Ÿè®¡)
        token_name (str):      æŒ‰ä»¤ç‰Œåç§°ç­›é€‰ (ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ç­›é€‰)
        token_group (str):     æŒ‰ä»¤ç‰Œåˆ†ç»„ç­›é€‰ (ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ç­›é€‰)
        model_name (str):      æŒ‰æ¨¡å‹åç§°ç­›é€‰ (ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ç­›é€‰)

    Returns:
        dict: åŒ…å«ç»Ÿè®¡æ•°æ®çš„å­—å…¸ï¼Œç»“æ„å¦‚ä¸‹:
              {
                  "quota": int,  # æ€»æ¶ˆè€—é¢åº¦ 
                  "rpm": int,    # æ¯åˆ†é’Ÿè¯·æ±‚æ•°
                  "tpm": int,    # æ¯åˆ†é’Ÿ Token æ•°
                  "mpm": int     # æ¯åˆ†é’Ÿæ¶ˆæ¯æ•°
              }
              è¯·æ±‚å¤±è´¥æ—¶è¿”å›ç©ºå­—å…¸ {}

    Raises:
        æ— å¼‚å¸¸æŠ›å‡ºï¼Œé”™è¯¯ä¿¡æ¯é€šè¿‡ print è¾“å‡º
    """
    # -------------------------------------------------------------------------
    # æ„å»ºè¯·æ±‚å¤´ - ä½¿ç”¨ Token è®¤è¯
    # -------------------------------------------------------------------------
    headers = {
        "Accept": "application/json",              # æœŸæœ›è¿”å› JSON æ ¼å¼
        "Authorization": f"{SYSTEM_TOKEN}", # Token è®¤è¯
        "Rix-Api-User": USER_ID,                   # ç”¨æˆ·æ ‡è¯†å¤´
    }

    # -------------------------------------------------------------------------
    # æ„å»ºæŸ¥è¯¢å‚æ•°
    # -------------------------------------------------------------------------
    params = {
        "type": stat_type,                    # ç»Ÿè®¡ç±»å‹
        "token_name": token_name,             # ä»¤ç‰Œåç§°ç­›é€‰
        "token_group": token_group,           # ä»¤ç‰Œåˆ†ç»„ç­›é€‰
        "model_name": model_name,             # æ¨¡å‹åç§°ç­›é€‰
        "start_timestamp": start_timestamp,   # å¼€å§‹æ—¶é—´æˆ³
        "end_timestamp": end_timestamp        # ç»“æŸæ—¶é—´æˆ³
    }

    # -------------------------------------------------------------------------
    # å‘é€ GET è¯·æ±‚
    # -------------------------------------------------------------------------
    response = requests.get(URL, headers=headers, params=params)

    # æ£€æŸ¥ HTTP çŠ¶æ€ç 
    if response.status_code != 200:
        print(f"è¯·æ±‚å¤±è´¥: HTTP {response.status_code}")
        return {}

    # -------------------------------------------------------------------------
    # è§£æå“åº”æ•°æ®
    # -------------------------------------------------------------------------
    result = response.json()

    # æ£€æŸ¥ä¸šåŠ¡çŠ¶æ€
    if not result.get("success"):
        print(f"æ¥å£è¿”å›é”™è¯¯: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
        return {}

    return result.get("data", {})


def print_stat(data: dict, start_time: datetime, end_time: datetime):
    """
    æ ¼å¼åŒ–è¾“å‡ºç»Ÿè®¡æ•°æ®

    å°† API è¿”å›çš„ç»Ÿè®¡æ•°æ®ä»¥ç¾è§‚çš„è¡¨æ ¼å½¢å¼è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚

    Args:
        data (dict):           API è¿”å›çš„ç»Ÿè®¡æ•°æ®å­—å…¸
                               å¿…é¡»åŒ…å«: quota, rpm, tpm, mpm å­—æ®µ
        start_time (datetime): æŸ¥è¯¢å¼€å§‹æ—¶é—´
        end_time (datetime):   æŸ¥è¯¢ç»“æŸæ—¶é—´

    Returns:
        None: ç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°

    è¾“å‡ºæ ¼å¼:
        ==================================================
                      API æ€»æ¶ˆè€—ç»Ÿè®¡
        ==================================================
        æŸ¥è¯¢æ—¶é—´: YYYY-MM-DD HH:MM è‡³ YYYY-MM-DD HH:MM
        --------------------------------------------------
          æ€»æ¶ˆè€—é¢åº¦: X.XXXX
          åŸå§‹å€¼: XXXXXXXX
        --------------------------------------------------
          æ¯åˆ†é’Ÿè¯·æ±‚æ•° (RPM): XXX
          æ¯åˆ†é’ŸTokenæ•° (TPM): XXXXXXX
          æ¯åˆ†é’Ÿæ¶ˆæ¯æ•° (MPM): XXXXXXX
        ==================================================
    """
    # -------------------------------------------------------------------------
    # è¾“å‡ºè¡¨å¤´
    # -------------------------------------------------------------------------
    print("=" * 50)
    print("              API æ€»æ¶ˆè€—ç»Ÿè®¡")
    print("=" * 50)
    print(f"æŸ¥è¯¢æ—¶é—´: {start_time.strftime('%Y-%m-%d %H:%M')} è‡³ {end_time.strftime('%Y-%m-%d %H:%M')}")
    print("-" * 50)

    # -------------------------------------------------------------------------
    # æ•°æ®ä¸ºç©ºæ—¶çš„å¤„ç†
    # -------------------------------------------------------------------------
    if not data:
        print("  æ²¡æœ‰æ•°æ®")
        print("=" * 50)
        return

    # -------------------------------------------------------------------------
    # æå–å¹¶è½¬æ¢æ•°æ®
    # -------------------------------------------------------------------------
    quota = data.get("quota", 0)           # åŸå§‹é¢åº¦å€¼
    actual_quota = quota / 500000          # è½¬æ¢ä¸ºå®é™…é¢åº¦

    # -------------------------------------------------------------------------
    # è¾“å‡ºç»Ÿè®¡ç»“æœ
    # -------------------------------------------------------------------------
    print(f"  æ€»æ¶ˆè€—é¢åº¦: {actual_quota:.4f}")
    print(f"  åŸå§‹å€¼: {quota}")
    print("-" * 50)
    print(f"  æ¯åˆ†é’Ÿè¯·æ±‚æ•° (RPM): {data.get('rpm', 0)}")
    print(f"  æ¯åˆ†é’ŸTokenæ•° (TPM): {data.get('tpm', 0)}")
    print(f"  æ¯åˆ†é’Ÿæ¶ˆæ¯æ•° (MPM): {data.get('mpm', 0)}")
    print("=" * 50)


def get_time_range(mode: str) -> tuple:
    """
    æ ¹æ®æŸ¥è¯¢æ¨¡å¼è·å–æ—¶é—´èŒƒå›´

    Args:
        mode (str): æŸ¥è¯¢æ¨¡å¼
                    - "today": ä»Šå¤©
                    - "yesterday": æ˜¨å¤©
                    - "week": æœ€è¿‘7å¤©
                    - "month": æœ€è¿‘30å¤©
                    - "custom": è‡ªå®šä¹‰æ—¶é—´èŒƒå›´

    Returns:
        tuple: (start_timestamp, end_timestamp, start_time, end_time)
    """
    from datetime import timedelta

    now = datetime.now()
    today = now.replace(hour=0, minute=0, second=0, microsecond=0)

    if mode == "today":
        start_time = today
        end_time = today.replace(hour=23, minute=59, second=59)
    elif mode == "yesterday":
        start_time = today - timedelta(days=1)
        end_time = start_time.replace(hour=23, minute=59, second=59)
    elif mode == "week":
        start_time = today - timedelta(days=6)
        end_time = now
    elif mode == "month":
        start_time = today - timedelta(days=29)
        end_time = now
    elif mode == "custom":
        try:
            if len(CUSTOM_START) == 10:
                start_time = datetime.strptime(CUSTOM_START, "%Y-%m-%d")
            else:
                start_time = datetime.strptime(CUSTOM_START, "%Y-%m-%d %H:%M:%S")

            if len(CUSTOM_END) == 10:
                end_time = datetime.strptime(CUSTOM_END, "%Y-%m-%d").replace(hour=23, minute=59, second=59)
            else:
                end_time = datetime.strptime(CUSTOM_END, "%Y-%m-%d %H:%M:%S")
        except ValueError as e:
            print(f"æ—¶é—´æ ¼å¼é”™è¯¯: {e}")
            print("è¯·ä½¿ç”¨æ ¼å¼: YYYY-MM-DD æˆ– YYYY-MM-DD HH:MM:SS")
            exit(1)
    else:
        print(f"æœªçŸ¥çš„æŸ¥è¯¢æ¨¡å¼: {mode}")
        print("æ”¯æŒçš„æ¨¡å¼: today, yesterday, week, month, custom")
        exit(1)

    return int(start_time.timestamp()), int(end_time.timestamp()), start_time, end_time


# ==============================================================================
#                               ä¸»ç¨‹åºå…¥å£
# ==============================================================================

if __name__ == "__main__":
    """
    ä¸»ç¨‹åºæ‰§è¡Œæµç¨‹:

    1. æ ¹æ®é…ç½®çš„æŸ¥è¯¢æ¨¡å¼è·å–æ—¶é—´èŒƒå›´
    2. è°ƒç”¨ API è·å–ç»Ÿè®¡æ•°æ®
    3. æ ¼å¼åŒ–è¾“å‡ºç»Ÿè®¡ç»“æœ
    """

    # -------------------------------------------------------------------------
    # Step 1: æ ¹æ®é…ç½®è·å–æ—¶é—´èŒƒå›´
    # -------------------------------------------------------------------------
    start_timestamp, end_timestamp, start_time, end_time = get_time_range(QUERY_MODE)

    # -------------------------------------------------------------------------
    # Step 2: æ˜¾ç¤ºæŸ¥è¯¢ä¿¡æ¯
    # -------------------------------------------------------------------------
    print(f"æŸ¥è¯¢æ¨¡å¼: {QUERY_MODE}")
    print(f"æŸ¥è¯¢æ—¶é—´èŒƒå›´: {start_time.strftime('%Y-%m-%d %H:%M:%S')} è‡³ {end_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print()

    # -------------------------------------------------------------------------
    # Step 3: è°ƒç”¨ API è·å–æ•°æ®å¹¶è¾“å‡º
    # -------------------------------------------------------------------------
    data = get_stat_data(start_timestamp, end_timestamp)
    print_stat(data, start_time, end_time)


```
## è¿”å›ç¤ºä¾‹
```json
==================================================
              API æ€»æ¶ˆè€—ç»Ÿè®¡
==================================================
æŸ¥è¯¢æ—¶é—´: 2025-12-09 00:00 è‡³ 2025-12-09 23:59
--------------------------------------------------
  æ€»æ¶ˆè€—é¢åº¦: 0.0997
  åŸå§‹å€¼: 49853
--------------------------------------------------
  æ¯åˆ†é’Ÿè¯·æ±‚æ•° (RPM): 0
  æ¯åˆ†é’ŸTokenæ•° (TPM): 0
  æ¯åˆ†é’Ÿæ¶ˆæ¯æ•° (MPM): 0
==================================================
```



<p align="center">
  <small>Â© 2025 DMXAPI æ€»æ¶ˆè€— æ—¥å¿—æŸ¥è¯¢ ğŸŒ</small>
</p>